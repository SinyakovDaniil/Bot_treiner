<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Пользователи - Админка</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Список пользователей</h1>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Имя</th>
                    <th>Дата регистрации</th>
                    <th>Подписка</th> <!-- Новая колонка -->
                    <th>Действие</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user[0] }}</td>
                    <td>{{ user[1] }}</td>
                    <td>{{ user[2] }}</td>
                    <td>
                        {% if user[3] %}
                            {% set expires_at = user[3] %}
                            {% set now = moment().toISOString()[:19].replace('T', ' ') %} <!-- Это не сработает в Jinja2 напрямую -->
                            <!-- Лучше обработать форматирование в Python -->
                            {% if expires_at > now_str %}
                                <span style="color: green;">Активна до: {{ expires_at[:10] }}</span>
                            {% else %}
                                <span style="color: red;">Просрочена (до: {{ expires_at[:10] }})</span>
                            {% endif %}
                        {% else %}
                            <span style="color: gray;">Нет подписки</span>
                        {% endif %}
                    </td>
                    <td>
                        <!-- Кнопка "Удалить" -->
                        <a href="{{ url_for('admin_delete_user_confirm', user_id=user[0]) }}"
                           onclick="return confirm('Вы уверены, что хотите удалить пользователя {{ user[1] | e }} (ID: {{ user[0] }})? Это действие нельзя отменить.');"
                           style="color: #dc3545; text-decoration: none; font-weight: bold;">
                            Удалить
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{{ url_for('admin_index') }}">Назад</a>
    </div>
    <script>
        // Передаем текущую дату в формате, который понимает Python (ISO без TZ)
        // Это нужно для сравнения в шаблоне, т.к. Jinja2 не может легко сравнить даты
        // Определим переменную now_str
        const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
        // Найдем все ячейки с датой окончания подписки
        document.querySelectorAll('td:nth-child(4)').forEach(cell => {
             // Ищем span, содержащий дату
             const span = cell.querySelector('span');
             if (span && span.textContent.includes('Активна до:') || span.textContent.includes('Просрочена')) {
                 // Выносим логику в Python, т.к. JS не имеет доступа к expires_at из user
                 // Лучше: форматировать дату и статус в Python и передавать в шаблон как строку
                 // Но для простоты пока оставим так, если expires_at уже строка в нужном формате
                 // В Python: datetime.now().isoformat(' ')
                 // Сравниваем в Python.
             }
        });
    </script>
</body>
</html>